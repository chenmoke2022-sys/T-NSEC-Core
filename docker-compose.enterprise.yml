services:
  tnsec:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      T_NSEC_HOST: 0.0.0.0
      T_NSEC_PORT: 8088
      T_NSEC_OLLAMA_BASE_URL: http://host.docker.internal:11434
      T_NSEC_OLLAMA_DRAFT_MODEL: qwen2.5:0.5b
      T_NSEC_OLLAMA_VERIFY_MODEL: qwen2.5:7b
      # Optional:
      # T_NSEC_API_KEY: "change-me"
      # T_NSEC_RATE_RPS: "5"
      # T_NSEC_RATE_BURST: "20"
    ports:
      - "8088:8088"
    restart: unless-stopped
    healthcheck:
      # 说明：runtime 镜像为 node:20-alpine，默认不包含 curl/wget。
      # 使用 Node 20 内置 fetch 来做健康检查，保证容器内可执行。
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://127.0.0.1:8088/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""
        ]
      interval: 30s
      timeout: 10s
      retries: 3
