# 附录 B：H‑Spec 门控机制验证（输入级 vs 输出级一致性）

## 1. 实验背景与目的

在 CPU 受限环境下，H‑Spec 调度器的核心挑战在于：如何以极低的计算开销（亚毫秒级）准确判断小模型（Draft）的输出是否足以满足质量要求，从而决定是否启动大模型（Verify）进行纠错。

本实验旨在验证基于向量映射一致性的门控机制在不同定义下的表现，并探索有效的阈值校准策略。

## 2. 实验设置

- **对齐头 (W)**：使用 `qwen-sentence-align v2.1` 训练的线性映射矩阵。
- **基准模型**：Draft (0.5B) vs Verify (7B)。
- **评价指标**：`cos(W * draft_emb, verify_emb)`。
- **验证集**：30 条涵盖认知、系统、逻辑等领域的混合测试样本。

---

## 3. 门控定义对比与现象分析

### A. 输入级一致性 (Input‑level Gate)
- **定义**：直接对比“同一输入文本”在两个模型下的 embedding 映射。
- **观察结果**：在 v2.1 对齐后，Accept Rate 接近 100%。
- **结论**：输入级门控具有极高的稳定性，适合用于 **Query Understanding** 或 **检索路由**，但在区分模型生成质量方面缺乏灵敏度。

### B. 输出级一致性 (Output‑level Gate)
- **定义**：让 Draft 与 Verify 分别生成完整回答，对比“生成文本”的 embedding。
- **观察结果**：默认阈值 (0.85) 下 Accept Rate 为 0%（全拒绝）。
- **根因分析**：
  1. **定义过严**：映射矩阵 W 针对短句训练，对长段回答的语义空间覆盖不足。
  2. **格式差异**：不同规模模型在 Markdown 列表、编号、标点风格上的显著差异引入了噪声。

---

## 4. 关键改进：阈值校准与输出口径约束

为使输出级门控具备工程实用性，本项目执行了两项关键校准：

### 1) 阈值扫描与重定
将扫描区间从 0.7~0.9 下探至 **0.20~0.60**，揭示了真实的语义分布曲线。

### 2) 输出口径规范化 (Normalization)
引入了轻量级输出约束逻辑：
- 限制最大行数与每行字数。
- 剥离编号、Markdown 语法及特定风格字符。

### 3) 校准结果 (n=28)

| 类型 | 平均相似度 | P50 | P95 |
|---|---|---|---|
| **Raw (原始输出)** | 0.4423 | 0.4664 | 0.5614 |
| **Normalized (口径约束后)** | **0.5042** | **0.5023** | **0.5979** |
| **提升 (Avg)** | **+14.0%** | - | - |

---

## 5. 结论：推荐路由策略

| 策略目标 | 推荐阈值 | 预期接受率 (Accept) | 成本节省 (Est.) |
|---|---|---|---|
| **效率优先 (省钱)** | 0.50 | ~25.0% | ~15% |
| **质量优先 (稳定)** | 0.55 | ~14.3% | ~4.3% |

**注意**：本实验证明了语义一致性路由的技术可行性。实际部署需配合人类偏好 (RLHF) 持续微调阈值。

---
**证据产物清单：**
- 原始报告：`benchmark/qwen-sentence-align/reports/hspec_gate_v2_1_output_real_report.md`
- 校准报告：`benchmark/qwen-sentence-align/reports/hspec_gate_v2_1_output_calibrated_report.md`
- 指标数据：`benchmark/qwen-sentence-align/reports/hspec_gate_v2_1_output_calibrated_metrics.csv`
