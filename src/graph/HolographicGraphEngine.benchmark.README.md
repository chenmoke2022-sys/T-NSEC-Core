# HolographicGraphEngine 性能基准测试

## 📋 概述

本基准测试用于验证 HolographicGraphEngine（基于 HDC 的全息图编码引擎）的 O(1) 时间复杂度特性。

### 测试目标

- 验证 HDC 方法的 O(1) 时间复杂度
- 测量不同图谱规模（1,000 - 100,000 节点）下的查询延迟
- 生成性能报告和 CSV 数据用于分析

### 测试方法

1. **图谱生成**：为每个测试规模生成随机图谱
   - 节点类型：concept, entity, event, property, relation
   - 平均度数：3-5 条边/节点
   - 关系类型：is_a, has_a, part_of, related_to, causes 等

2. **预编码**：使用 HSGE 对所有节点进行结构编码
   - 编码范围：2 跳子图
   - 使用 HDC 超维向量表示

3. **查询测试**：对每个规模执行 1,000 次随机查询
   - 随机选择查询节点
   - 使用 HDC 相似性搜索
   - 返回 Top-5 结果

4. **性能统计**：
   - 平均查询延迟
   - 最小/最大延迟
   - P50/P95/P99 分位数
   - 查询吞吐量 (QPS)

## 🚀 使用方法

### 运行完整基准测试

```bash
npm run benchmark-holographic
```

或直接运行：

```bash
npx tsx scripts/benchmark-holographic.ts
```

### 自定义配置

在代码中修改配置：

```typescript
import { HolographicGraphEngineBenchmark } from './src/graph/HolographicGraphEngine.benchmark.js';

const benchmark = new HolographicGraphEngineBenchmark({
  minNodes: 1000,        // 最小节点数
  maxNodes: 100000,      // 最大节点数
  stepSize: 5000,        // 步长（每 5K 节点一个测试点）
  queriesPerScale: 1000, // 每个规模的查询次数
  outputCsvPath: './reports/holographic-benchmark.csv',
  hops: 2,               // 子图跳数
  topK: 5,               // 返回的 top-K 结果
});

await benchmark.run();
```

## 📊 输出结果

### CSV 报告

测试完成后会生成 CSV 文件：`./reports/holographic-benchmark.csv`

包含以下列：
- `节点数`：测试的图谱节点数
- `边数`：生成的边数
- `查询次数`：执行的查询次数
- `平均延迟(ms)`：平均查询延迟（毫秒）
- `最小延迟(ms)`：最小查询延迟
- `最大延迟(ms)`：最大查询延迟
- `P50(ms)`：中位数延迟
- `P95(ms)`：95 分位数延迟
- `P99(ms)`：99 分位数延迟
- `总耗时(ms)`：总测试时间
- `QPS`：查询吞吐量（每秒查询数）
- `编码时间(ms)`：节点编码总耗时
- `搜索时间(ms)`：搜索总耗时

### 摘要报告

同时生成文本摘要：`./reports/holographic-benchmark-summary.txt`

包含：
- 测试配置信息
- 延迟变化趋势分析
- O(1) 复杂度验证结果
- 详细性能数据表格

## 📈 结果分析

### O(1) 复杂度验证

基准测试会分析延迟随图谱规模的变化：

- **✅ 符合 O(1)**：延迟增长 < 1.5x（即使节点数增长 100x）
- **⚠️ 接近 O(1)**：延迟增长 < log(规模增长)
- **❌ 不符合 O(1)**：延迟增长明显

### 预期结果

理论上，HDC 方法应该：
- 查询延迟基本恒定（O(1)）
- 延迟主要取决于：
  - 超向量维度（固定）
  - 缓存中的签名数量（固定或线性增长）
  - Hamming 距离计算（O(1)）

实际测试中，如果延迟增长缓慢，说明：
- HDC 编码有效
- 缓存机制工作良好
- 查询复杂度接近 O(1)

## ⚙️ 技术细节

### 测试架构

```
HolographicGraphEngineBenchmark
├── GraphManager (SQLite)
│   └── 存储节点和边
├── HSGE (Holographic Sparse Graph Encoding)
│   ├── HDCEngine (超维计算)
│   └── 结构签名编码
└── 性能测量
    ├── 编码时间
    ├── 查询延迟
    └── 统计信息
```

### 关键操作

1. **结构编码** (`encodeNodeStructure`)
   - 提取节点的 2 跳子图
   - 将三元组编码为超向量
   - 叠加所有三元组向量

2. **相似性搜索** (`fastSearch`)
   - 计算查询向量与所有缓存的相似度
   - 使用 Hamming 距离（O(1)）
   - 返回 Top-K 结果

### 性能瓶颈

可能的性能瓶颈：
- 图谱生成（SQLite 写入）
- 节点编码（子图提取 + HDC 编码）
- 相似度计算（如果缓存很大）

优化方向：
- 批量编码
- 并行查询
- 索引优化

## 🔍 故障排除

### 内存不足

如果测试大规模图谱时内存不足：

```typescript
// 减少测试规模
const benchmark = new HolographicGraphEngineBenchmark({
  maxNodes: 50000,  // 降低最大节点数
  stepSize: 10000,  // 增大步长
});
```

### 测试时间过长

如果测试时间过长：

```typescript
// 减少查询次数
const benchmark = new HolographicGraphEngineBenchmark({
  queriesPerScale: 100,  // 减少到 100 次
});
```

### 数据库锁定

如果遇到数据库锁定错误，确保：
- 没有其他进程访问测试数据库
- 临时数据库文件已正确清理

## 📚 相关文档

- [HSGE 模块文档](./HSGE.ts)
- [HDC Engine 文档](../hdc/HDCEngine.ts)
- [GraphManager 文档](./GraphManager.ts)

## 📝 示例输出

```
╔════════════════════════════════════════════════════════════╗
║     HolographicGraphEngine 性能基准测试摘要              ║
╠════════════════════════════════════════════════════════════╣
║ 测试时间: 2024-01-15T10:30:00.000Z                        ║
║ 测试规模: 1,000 - 100,000 节点                            ║
║ 每规模查询次数: 1,000                                     ║
╠════════════════════════════════════════════════════════════╣
║ 延迟分析 (验证 O(1) 复杂度):                              ║
╠════════════════════════════════════════════════════════════╣
║ 节点规模增长: 100.0x                                      ║
║ 平均延迟增长: 1.2x                                        ║
║ ✅ 延迟基本恒定，符合 O(1) 复杂度理论                      ║
╠════════════════════════════════════════════════════════════╣
║ 详细结果:                                                 ║
╠════════════════════════════════════════════════════════════╣
║ 节点数      │ 平均延迟(ms) │ P95(ms) │ QPS    ║
╠════════════════════════════════════════════════════════════╣
║       1000 │       2.345 │  3.120 │ 426.5 ║
║       5000 │       2.456 │  3.234 │ 407.2 ║
║      10000 │       2.512 │  3.345 │ 398.1 ║
║      50000 │       2.678 │  3.567 │ 373.4 ║
║     100000 │       2.789 │  3.789 │ 358.6 ║
╚════════════════════════════════════════════════════════════╝
```

